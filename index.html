<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Attendance Helper</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- OPTIONAL (only used when running inside Outlook add-in) -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

  <!-- CSV + Excel parsers -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#fff5f8;        /* soft light pink */
      --primary:#e06287;   /* rose pink */
      --primary-d:#c65074; /* darker hover */
      --text:#333;
      --muted:#666;
      --card:#ffffff;
      --border:#f0d7df;
    }
    * { box-sizing: border-box; }
    body{
      margin:0; font-family: 'Segoe UI', Arial, sans-serif; color:var(--text);
      background:linear-gradient(180deg, var(--bg), #ffffff);
      min-height: 100vh; display:flex; align-items:center; justify-content:center;
    }
    .wrap{
      width:min(760px, 92vw); background:var(--card); border:1px solid var(--border);
      border-radius:16px; padding:20px; box-shadow:0 6px 30px rgba(0,0,0,0.06);
    }
    header{ display:flex; align-items:center; gap:12px; margin-bottom:8px; }
    .logo{
      width:38px; height:38px; border-radius:10px; border:2px solid var(--primary);
      display:grid; place-items:center; color:var(--primary); font-weight:700;
    }
    h1{ font-size:20px; margin:0; color:var(--primary); }
    .sub{ color:var(--muted); font-size:13px; margin-bottom:18px; }

    .card{
      border:1px solid var(--border); border-radius:12px; padding:16px; background:#fff; margin-top:12px;
    }
    label{ font-size:13px; color:#444; display:block; margin-bottom:6px; }
    input[type="file"], select, input[type="text"]{
      width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff;
    }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .btn{
      background:var(--primary); color:#fff; border:none; border-radius:10px; padding:10px 14px;
      cursor:pointer; font-weight:600; transition:.2s;
    }
    .btn:hover{ background:var(--primary-d); }
    .btn.secondary{ background:#fff; color:var(--primary); border:1px solid var(--primary); }
    .pill{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--border); color:#555; background:#fff;
    }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; }
    .muted{ color:#888; font-size:12px; }
    .grid{
      width:100%; border-collapse:collapse; font-size:13px; margin-top:8px;
    }
    .grid th, .grid td{ border:1px solid var(--border); padding:8px; }
    .grid th{ background:#fff8fb; text-align:left; }
    .right{ display:flex; gap:8px; justify-content:flex-end; }
    .hint{ font-size:12px; color:#777; margin-top:6px; }
    footer{ margin-top:10px; text-align:center; color:#999; font-size:12px; }
  </style>
</head>
<body>
  <main class="wrap">
    <header>
      <div class="logo">AH</div>
      <div>
        <h1>Attendance Helper</h1>
        <div class="sub">Upload a spreadsheet ‚Üí map columns ‚Üí filter by response ‚Üí copy or add to Outlook.</div>
      </div>
    </header>

    <!-- 1) Upload -->
    <section class="card">
      <label>1) Upload CSV or Excel (.csv, .xlsx)</label>
      <input id="file" type="file" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" />
      <div class="hint">Tip: Export your list from Sheets/Excel as CSV if you‚Äôre unsure.</div>
    </section>

    <!-- 2) Map columns -->
    <section class="card">
      <div class="row">
        <div>
          <label>2) Select email column</label>
          <select id="emailCol" disabled></select>
        </div>
        <div>
          <label>3) Select ‚Äútarget event‚Äù column (optional)</label>
          <select id="eventCol" disabled></select>
        </div>
      </div>
      <div style="margin-top:12px" class="row">
        <div>
          <label>Filter to one event name (optional)</label>
          <input id="eventNameFilter" placeholder="e.g., All Hands ‚Äì Nov 2025" />
        </div>
        <div>
          <label>4) Filter by Response</label>
          <select id="responseFilter">
            <option value="ALL">All</option>
            <option>Accepted</option>
            <option>Declined</option>
            <option>Tentative</option>
            <option>Unknown</option>
            <option>None</option>
          </select>
        </div>
      </div>
      <div class="hint">Your sheet needs a ‚ÄúResponse‚Äù column (values like Accepted / Declined / Tentative / Unknown). You can rename it below if your header is different.</div>
      <div style="margin-top:8px" class="row">
        <div>
          <label>Response column name in your file</label>
          <input id="responseColName" placeholder="Default: Response (leave blank if it is literally 'Response')" />
        </div>
        <div style="display:flex; align-items:flex-end; gap:8px; justify-content:flex-end">
          <button class="btn" id="previewBtn">Preview</button>
          <button class="btn secondary" id="clearBtn">Clear</button>
        </div>
      </div>
    </section>

    <!-- 5/6) Preview + Actions -->
    <section class="card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div class="chips">
          <span class="pill">Rows: <strong id="rowsCount">0</strong></span>
          <span class="pill">Emails: <strong id="emailsCount">0</strong></span>
          <span class="pill">Filter: <strong id="filterLabel">All</strong></span>
        </div>
        <div class="right">
          <button class="btn secondary" id="copyBtn">üìã Copy emails</button>
          <button class="btn" id="addToOutlookBtn">‚ûï Add to Outlook event</button>
        </div>
      </div>
      <table class="grid" id="previewTable" style="display:none">
        <thead><tr><th>#</th><th>Email</th><th>Event</th><th>Response</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="hint">If ‚ÄúAdd to Outlook‚Äù doesn‚Äôt work in your desktop, it‚Äôll still copy ‚Äî paste into required attendees.</div>
    </section>

    <footer>¬© 2025 SharkByte Project ‚Ä¢ UI ‚ú®</footer>
  </main>

  <script>
    // ------------------------ STATE ------------------------
    let rawRows = [];      // array of objects from sheet
    let headers = [];      // discovered column names

    const els = {
      file: document.getElementById('file'),
      emailCol: document.getElementById('emailCol'),
      eventCol: document.getElementById('eventCol'),
      respFilter: document.getElementById('responseFilter'),
      respColName: document.getElementById('responseColName'),
      eventNameFilter: document.getElementById('eventNameFilter'),
      rowsCount: document.getElementById('rowsCount'),
      emailsCount: document.getElementById('emailsCount'),
      filterLabel: document.getElementById('filterLabel'),
      previewBtn: document.getElementById('previewBtn'),
      clearBtn: document.getElementById('clearBtn'),
      copyBtn: document.getElementById('copyBtn'),
      addBtn: document.getElementById('addToOutlookBtn'),
      table: document.getElementById('previewTable'),
      tbody: document.querySelector('#previewTable tbody'),
    };

    // ------------------------ LOAD FILE ------------------------
    els.file.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const name = file.name.toLowerCase();

      try {
        if (name.endsWith('.csv')) {
          await parseCSV(file);
        } else {
          await parseXLSX(file);
        }
        hydrateColumnDropdowns();
        toast('File loaded.');
      } catch (err) {
        alert('Could not read file: ' + err);
      }
    });

    function parseCSV(file){
      return new Promise((resolve, reject) => {
        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: (res) => {
            rawRows = res.data || [];
            headers = res.meta?.fields || [];
            resolve();
          },
          error: reject
        });
      });
    }

    async function parseXLSX(file){
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, { type:'array' });
      const sheetName = wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];
      rawRows = XLSX.utils.sheet_to_json(ws, { defval: '' });
      if (rawRows.length) headers = Object.keys(rawRows[0]);
    }

    function hydrateColumnDropdowns(){
      fillSelect(els.emailCol, headers);
      fillSelect(els.eventCol, ['(none)', ...headers]);
      els.emailCol.disabled = false;
      els.eventCol.disabled = false;
    }
    function fillSelect(sel, items){
      sel.innerHTML = '';
      for (const h of items){
        const opt = document.createElement('option');
        opt.textContent = h;
        opt.value = h;
        sel.appendChild(opt);
      }
    }

    // ------------------------ FILTER + PREVIEW ------------------------
    els.previewBtn.addEventListener('click', () => renderPreview());
    els.clearBtn.addEventListener('click', () => {
      rawRows = []; headers = [];
      els.file.value = '';
      els.emailCol.innerHTML = ''; els.eventCol.innerHTML = '';
      els.emailCol.disabled = true; els.eventCol.disabled = true;
      els.respFilter.value = 'ALL';
      els.respColName.value = '';
      els.eventNameFilter.value = '';
      els.rowsCount.textContent = '0';
      els.emailsCount.textContent = '0';
      els.filterLabel.textContent = 'All';
      els.table.style.display = 'none';
      els.tbody.innerHTML = '';
    });

    function renderPreview(){
      if (!rawRows.length){ alert('Upload a file first.'); return; }
      const emailKey = els.emailCol.value;
      if (!emailKey){ alert('Pick the email column.'); return; }

      const respKey = (els.respColName.value || 'Response').trim();
      const eventKey = els.eventCol.value === '(none)' ? null : els.eventCol.value;
      const eventName = els.eventNameFilter.value.trim();
      const filterVal = els.respFilter.value;

      const filtered = rawRows.filter(row => {
        const email = String(row[emailKey] || '').trim();
        if (!email) return false;

        // optional: filter by event name
        if (eventKey && eventName){
          const ev = String(row[eventKey] || '').trim();
          if (!ev || ev.toLowerCase() !== eventName.toLowerCase()) return false;
        }

        // response filter
        if (filterVal !== 'ALL'){
          const resp = String(row[respKey] || '').trim();
          if (!equalsResponse(resp, filterVal)) return false;
        }
        return true;
      });

      // dedupe & basic email sanity
      const list = Array.from(new Set(filtered
        .map(r => String(r[emailKey] || '').trim())
        .filter(e => /\S+@\S+\.\S+/.test(e))));

      // table
      els.tbody.innerHTML = '';
      filtered.slice(0, 150).forEach((r, i) => {
        const tr = document.createElement('tr');
        const evName = eventKey ? (r[eventKey] || '') : '';
        const resp = (r[(els.respColName.value || 'Response').trim()] || '');
        tr.innerHTML = `<td>${i+1}</td><td>${r[emailKey] || ''}</td><td>${evName}</td><td>${resp}</td>`;
        els.tbody.appendChild(tr);
      });
      els.table.style.display = filtered.length ? 'table' : 'none';

      // counts
      els.rowsCount.textContent = String(filtered.length);
      els.emailsCount.textContent = String(list.length);
      els.filterLabel.textContent = filterVal;

      // stash for actions
      window.__emails = list;
    }

    function equalsResponse(value, filter){
      const v = String(value || '').toLowerCase();
      const f = String(filter).toLowerCase();
      // normalize common values
      const map = {
        accepted:['accepted','yes','y','attending','accepted ‚úî','accepted‚úÖ'],
        declined:['declined','no','n','not attending','declined ‚ùå','declined‚úñ'],
        tentative:['tentative','maybe','unsure','tentative ü§î'],
        unknown:['unknown','', 'pending','no response','n/a'],
        none:['none','-','‚Äî']
      };
      if (f === 'all') return true;
      for (const [k, arr] of Object.entries(map)){
        if (k === f && arr.some(a => v === a)) return true;
      }
      // also exact match fallback
      return v === f;
    }

    // ------------------------ ACTIONS ------------------------
    els.copyBtn.addEventListener('click', async () => {
      const list = window.__emails || [];
      if (!list.length){ alert('Nothing to copy. Click Preview first.'); return; }
      const joined = list.join('; ');
      try {
        await navigator.clipboard.writeText(joined);
        toast('Emails copied to clipboard.');
      } catch(e){
        // fallback
        prompt('Copy these emails:', joined);
      }
    });

    els.addBtn.addEventListener('click', async () => {
      const list = window.__emails || [];
      if (!list.length){ alert('Nothing to add. Click Preview first.'); return; }

      // If we‚Äôre inside an Outlook Appointment compose, try to add attendees using Office.js
      try {
        if (window.Office && Office.context && Office.context.mailbox && Office.context.mailbox.item) {
          const item = Office.context.mailbox.item;

          // Only works in compose (editing/creating). In read mode or in web with limited perms, we fallback to copy.
          if (item.requiredAttendees && item.requiredAttendees.addAsync) {
            // Transform semicolon list to an array of { emailAddress: "..."}
            const entries = list.map(e => ({ emailAddress: e.trim() }));
            item.requiredAttendees.addAsync(entries, (asyncResult) => {
              if (asyncResult.status === Office.AsyncResultStatus.Succeeded) {
                toast('Added to Required attendees.');
              } else {
                console.warn(asyncResult.error);
                fallbackCopy(list);
              }
            });
          } else {
            // no addAsync available (read mode / older API) -> copy instead
            fallbackCopy(list);
          }
        } else {
          // not in Outlook add-in (just browser) -> copy
          fallbackCopy(list);
        }
      } catch(err){
        console.warn(err);
        fallbackCopy(list);
      }
    });

    function fallbackCopy(list){
      const joined = list.join('; ');
      navigator.clipboard.writeText(joined).then(
        ()=> toast('Copied. Paste into the event recipients.'),
        ()=> prompt('Copy these emails:', joined)
      );
    }

    // ------------------------ UI HELPERS ------------------------
    function toast(msg){
      const d = document.createElement('div');
      d.textContent = msg;
      d.style.position='fixed'; d.style.bottom='18px'; d.style.right='18px';
      d.style.background='var(--primary)'; d.style.color='#fff';
      d.style.borderRadius='10px'; d.style.padding='10px 14px'; d.style.boxShadow='0 4px 16px rgba(0,0,0,.12)';
      d.style.zIndex='999999';
      document.body.appendChild(d);
      setTimeout(()=>d.remove(), 1800);
    }
  </script>
</body>
</html>
